services:
  # APIサーバー (Go)
  api-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: slm-api-server
    ports:
      - "8080:8080"
    environment:
      # New Relic APM設定
      NEW_RELIC_API_KEY: ${NEW_RELIC_API_KEY}
      NEW_RELIC_APP_NAME: ${NEW_RELIC_APP_NAME:-slm-handson-api}

      # パフォーマンス調整用環境変数（デフォルト値をSLMデモ用に設定）
      ERROR_RATE: ${ERROR_RATE:-0.0}
      RESPONSE_TIME_MIN: ${RESPONSE_TIME_MIN:-50}
      RESPONSE_TIME_MAX: ${RESPONSE_TIME_MAX:-500}
      SLOW_ENDPOINT_RATE: ${SLOW_ENDPOINT_RATE:-0.0}

      # アプリケーション設定
      PORT: 8080
      HOST: 0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - slm-network

  # フロントエンドサーバー (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_BASE_URL: http://localhost:8080/api
        NEXT_PUBLIC_NEW_RELIC_BROWSER_KEY: ${NEXT_PUBLIC_NEW_RELIC_BROWSER_KEY}
        NEXT_PUBLIC_NEW_RELIC_ACCOUNT_ID: ${NEXT_PUBLIC_NEW_RELIC_ACCOUNT_ID}
        NEXT_PUBLIC_NEW_RELIC_APPLICATION_ID: ${NEXT_PUBLIC_NEW_RELIC_APPLICATION_ID}
    container_name: slm-frontend
    ports:
      - "3000:3000"
    environment:
      # ブラウザからアクセス可能なAPIサーバーURL
      NEXT_PUBLIC_API_BASE_URL: http://localhost:8080/api
      # Docker内部通信用APIサーバーURL
      INTERNAL_API_URL: http://api-server:8080/api
      NODE_ENV: production
    depends_on:
      api-server:
        condition: service_healthy
    networks:
      - slm-network

  # SLOハンズオン用ユーザーアクセス生成器（Go版）
  load-generator:
    build:
      context: ./scripts
      dockerfile: Dockerfile
    container_name: slm-access-generator
    environment:
      # アクセス先URL（フロントエンドを指定）
      TARGET_URL: ${TARGET_URL:-http://frontend:3000}
      # アクセス間隔（秒）
      ACCESS_INTERVAL: ${ACCESS_INTERVAL:-10}
      # 実行時間（秒）
      DURATION: ${DURATION:-300}
    depends_on:
      frontend:
        condition: service_started
      api-server:
        condition: service_healthy
    networks:
      - slm-network
    # profilesを使用して必要時のみ起動
    # docker-compose --profile load-test up で起動
    profiles:
      - load-test
    restart: unless-stopped

  # Playwrightベースの負荷生成器（RUM対応・軽量版）
  playwright-generator:
    build:
      context: ./scripts/playwright
      dockerfile: Dockerfile
    container_name: slm-playwright-generator
    environment:
      # アクセス先URL（フロントエンドを指定）
      TARGET_URL: ${TARGET_URL:-http://frontend:3000}
      # アクセス間隔（秒）
      ACCESS_INTERVAL: ${ACCESS_INTERVAL:-10}
      # 実行時間（秒）
      DURATION: ${DURATION:-300}
      # ヘッドレスモード（true/false）
      HEADLESS: ${HEADLESS:-true}
      # 同時実行ユーザー数
      CONCURRENT_USERS: ${CONCURRENT_USERS:-1}
    depends_on:
      frontend:
        condition: service_started
      api-server:
        condition: service_healthy
    networks:
      - slm-network
    # profilesを使用して必要時のみ起動
    # docker compose --profile playwright up で起動
    profiles:
      - playwright
    # restart: "no" を設定してテスト完了時に自動停止
    restart: "no"
    # Playwrightのブラウザ実行に必要な権限
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined

networks:
  slm-network:
    driver: bridge
