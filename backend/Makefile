# SLM ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ Makefile
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨CI/CD ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•åŒ–

.PHONY: help test test-docker test-unit test-integration test-coverage \
        build clean lint fmt vet security deps check-deps \
        docker-build docker-test docker-run coverage-html

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Goãƒãƒ¼ã‚¸ãƒ§ãƒ³
GO_VERSION ?= 1.21

# Dockerè¨­å®š
DOCKER_IMAGE_NAME = slm-handson-backend
DOCKER_TAG ?= latest

# ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
COVERAGE_FILE = coverage.out
COVERAGE_HTML = coverage.html

help: ## ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
	@echo "SLM ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ãƒ†ã‚¹ãƒˆé–¢é€£:"
	@echo "  make test              - å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make test-unit         - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-integration  - çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
	@echo "  make test-coverage     - ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo ""
	@echo "Dockeré–¢é€£:"
	@echo "  make docker-test       - Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
	@echo "  make docker-build      - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make docker-run        - Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œ"

# =============================================================================
# ä¾å­˜é–¢ä¿‚ç®¡ç†
# =============================================================================

deps: ## ä¾å­˜é–¢ä¿‚ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
	go mod download
	go mod verify

check-deps: ## ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
	@echo "ğŸ” ä¾å­˜é–¢ä¿‚ã®ç¢ºèª..."
	go mod verify
	go mod tidy

# =============================================================================
# ãƒ“ãƒ«ãƒ‰é–¢é€£
# =============================================================================

build: ## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰ä¸­..."
	@if command -v go >/dev/null 2>&1; then \
		go build -v -o bin/server ./cmd/server; \
	else \
		echo "âš ï¸  GoãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Dockerã‚’ä½¿ç”¨ã—ã¾ã™..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go build -v -o bin/server ./cmd/server; \
	fi

clean: ## ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	rm -rf bin/
	rm -f $(COVERAGE_FILE) $(COVERAGE_HTML)
	docker rmi $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) 2>/dev/null || true

# =============================================================================
# ãƒ†ã‚¹ãƒˆé–¢é€£
# =============================================================================

test: ## å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
	@echo "ğŸ§ª å…¨ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	./scripts/test.sh

test-docker: ## Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ³ Dockerç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	./scripts/test-docker.sh

test-unit: ## ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	@if command -v go >/dev/null 2>&1; then \
		echo "Goã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ..."; \
		echo "Domainå±¤ãƒ†ã‚¹ãƒˆ..."; \
		go test -v -timeout 30s ./internal/domain/entity/...; \
		echo ""; \
		echo "UseCaseå±¤ãƒ†ã‚¹ãƒˆ..."; \
		go test -v -timeout 30s ./internal/usecase/...; \
		echo ""; \
		echo "Infrastructureå±¤ãƒ†ã‚¹ãƒˆ..."; \
		go test -v -timeout 30s ./internal/infrastructure/...; \
		echo ""; \
		echo "Interfaceå±¤ãƒ†ã‚¹ãƒˆ..."; \
		go test -v -timeout 30s ./internal/interface/...; \
	else \
		echo "âš ï¸  GoãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Dockerã‚’ä½¿ç”¨ã—ã¾ã™..."; \
		echo "Domainå±¤ãƒ†ã‚¹ãƒˆ..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go test -v -timeout 30s ./internal/domain/entity/...; \
		echo ""; \
		echo "UseCaseå±¤ãƒ†ã‚¹ãƒˆ..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go test -v -timeout 30s ./internal/usecase/...; \
		echo ""; \
		echo "Infrastructureå±¤ãƒ†ã‚¹ãƒˆ..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go test -v -timeout 30s ./internal/infrastructure/...; \
		echo ""; \
		echo "Interfaceå±¤ãƒ†ã‚¹ãƒˆ..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go test -v -timeout 30s ./internal/interface/...; \
	fi

test-integration: ## çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
	@echo "ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	@if command -v go >/dev/null 2>&1; then \
		go test -v -timeout 60s ./test/integration/...; \
	else \
		echo "âš ï¸  GoãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Dockerã‚’ä½¿ç”¨ã—ã¾ã™..."; \
		docker run --rm -v $(PWD):/app -w /app golang:$(GO_VERSION) go test -v -timeout 60s ./test/integration/...; \
	fi

test-coverage: $(COVERAGE_FILE) ## ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
	go tool cover -func=$(COVERAGE_FILE) | tail -n 1

$(COVERAGE_FILE): ## ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šä¸­..."
	go test -coverprofile=$(COVERAGE_FILE) -timeout 60s ./...

coverage-html: $(COVERAGE_FILE) ## HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
	@echo "ğŸŒ HTMLã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
	go tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML)
	@echo "ğŸ“„ HTMLãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: $(COVERAGE_HTML)"

# =============================================================================
# ã‚³ãƒ¼ãƒ‰å“è³ª
# =============================================================================

lint: ## ã‚³ãƒ¼ãƒ‰ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°å®Ÿè¡Œ
	@echo "ğŸ” ã‚³ãƒ¼ãƒ‰ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ä¸­..."
	@command -v golangci-lint >/dev/null 2>&1 || { \
		echo "golangci-lint ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:"; \
		echo "curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b \$$(go env GOPATH)/bin v1.54.2"; \
		exit 1; \
	}
	golangci-lint run --timeout=5m

fmt: ## ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ
	@echo "ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	gofmt -w .
	go mod tidy

vet: ## go vet å®Ÿè¡Œ
	@echo "ğŸ” go vet å®Ÿè¡Œä¸­..."
	go vet ./...

check-fmt: ## ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
	@echo "ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ä¸­..."
	@if [ -n "$$(gofmt -l .)" ]; then \
		echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:"; \
		gofmt -l .; \
		echo "å®Ÿè¡Œã—ã¦ãã ã•ã„: make fmt"; \
		exit 1; \
	else \
		echo "âœ… å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™"; \
	fi

security: ## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
	@echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ä¸­..."
	@command -v gosec >/dev/null 2>&1 || { \
		echo "gosec ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•:"; \
		echo "go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest"; \
		exit 1; \
	}
	gosec ./...

# =============================================================================
# Dockeré–¢é€£
# =============================================================================

docker-build: ## Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ³ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ä¸­..."
	docker build -t $(DOCKER_IMAGE_NAME):$(DOCKER_TAG) .

docker-run: docker-build ## Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œ
	@echo "ğŸš€ Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
	docker run --rm -p 8080:8080 \
		-e NEW_RELIC_API_KEY="" \
		-e NEW_RELIC_APP_NAME="slm-handson-api-local" \
		$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)

docker-test-run: docker-build ## ãƒ†ã‚¹ãƒˆç”¨Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’å®Ÿè¡Œ
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨Dockerã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ä¸­..."
	docker run --rm -p 8080:8080 --name slm-test-app \
		-e NEW_RELIC_API_KEY="" \
		-e NEW_RELIC_APP_NAME="slm-handson-api-test" \
		$(DOCKER_IMAGE_NAME):$(DOCKER_TAG)

# =============================================================================
# CI/CDé–¢é€£
# =============================================================================

ci-test: deps check-fmt vet test-coverage ## CIç’°å¢ƒç”¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ¤– CIç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

ci-test-full: deps build check-fmt vet lint security test-coverage ## CIç’°å¢ƒç”¨ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
	@echo "ğŸ¤– CIç’°å¢ƒã§ã®ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"

# =============================================================================
# é–‹ç™ºæ”¯æ´
# =============================================================================

dev-setup: ## é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
	@echo "âš™ï¸ é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..."
	go mod download
	go mod verify
	@echo "âœ… é–‹ç™ºç’°å¢ƒã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ"
	@echo ""
	@echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
	@echo "1. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: make test"
	@echo "2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•: make docker-run"
	@echo "3. é–‹ç™ºç”¨ã‚³ãƒãƒ³ãƒ‰: make help"

run: build ## ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
	@echo "ğŸš€ ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ä¸­..."
	./bin/server

# =============================================================================
# æƒ…å ±è¡¨ç¤º
# =============================================================================

info: ## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
	@echo "ğŸ“‹ SLM ãƒãƒ³ã‚ºã‚ªãƒ³ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±"
	@echo "================================"
	@echo "Goãƒãƒ¼ã‚¸ãƒ§ãƒ³: $$(go version)"
	@echo "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $$(pwd)"
	@echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸: $(DOCKER_IMAGE_NAME):$(DOCKER_TAG)"
	@echo ""
	@echo "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:"
	@echo "- Domainå±¤: ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨ãƒ«ãƒ¼ãƒ«"
	@echo "- UseCaseå±¤: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯"
	@echo "- Interfaceå±¤: HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼"
	@echo "- Infrastructureå±¤: ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–"
	@echo ""
	@echo "ãƒ†ã‚¹ãƒˆæ§‹æˆ:"
	@echo "- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: å„å±¤ã®ãƒ†ã‚¹ãƒˆ"
	@echo "- çµ±åˆãƒ†ã‚¹ãƒˆ: E2Eãƒ†ã‚¹ãƒˆ"
	@echo "- ã‚«ãƒãƒ¬ãƒƒã‚¸: å…¨ä½“çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸"

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œæ¨©é™ã‚’ç¢ºä¿
scripts/test.sh:
	chmod +x scripts/test.sh

scripts/test-docker.sh:
	chmod +x scripts/test-docker.sh