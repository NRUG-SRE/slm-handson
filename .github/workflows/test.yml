name: Backend Test Suite

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - '.github/workflows/test.yml'

defaults:
  run:
    working-directory: ./backend

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: ['1.21', '1.22']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('backend/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-${{ matrix.go-version }}-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Verify dependencies
      run: go mod verify
    
    - name: Build application
      run: go build -v ./cmd/server
    
    - name: Run Domain layer tests
      run: go test -v -timeout 30s ./internal/domain/entity/...
    
    - name: Run UseCase layer tests
      run: go test -v -timeout 30s ./internal/usecase/...
    
    - name: Run Infrastructure layer tests
      run: go test -v -timeout 30s ./internal/infrastructure/...
    
    - name: Run Interface layer tests
      run: go test -v -timeout 30s ./internal/interface/...
    
    - name: Generate unit test coverage
      run: go test -v -timeout 60s -coverprofile=coverage.out ./internal/...
    
    - name: Display coverage summary
      run: go tool cover -func=coverage.out | tail -n 1
    
    - name: Generate coverage HTML report
      run: go tool cover -html=coverage.out -o coverage.html
    
    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-go-${{ matrix.go-version }}
        path: ./backend/coverage.html
        retention-days: 30

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Download dependencies
      run: go mod download
      working-directory: ./backend
    
    - name: Run go vet
      run: go vet ./...
      working-directory: ./backend
    
    - name: Run go fmt check
      run: |
        if [ -n "$(gofmt -l .)" ]; then
          echo "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“:"
          gofmt -l .
          exit 1
        fi
      working-directory: ./backend
    
    - name: Run staticcheck
      run: |
        go install honnef.co/go/tools/cmd/staticcheck@2023.1.6
        staticcheck ./...
      working-directory: ./backend

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Download dependencies
      run: go mod download
      working-directory: ./backend
    
    - name: Run gosec security scanner
      run: |
        go install github.com/securego/gosec/v2/cmd/gosec@v2.18.2
        gosec ./...
      working-directory: ./backend
      continue-on-error: true

  docker-test:
    name: Docker Test Environment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run unit tests with Docker
      run: |
        # Dockerç’°å¢ƒã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆã¯é™¤å¤–ï¼‰
        docker run --rm -v $(pwd):/app -w /app golang:1.21 \
          bash -c "
            echo 'ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰' &&
            go mod download &&
            echo 'ğŸ›ï¸ Domainå±¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ' &&
            go test -v -timeout 30s ./internal/domain/entity/... &&
            echo 'âš™ï¸ UseCaseå±¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ' &&
            go test -v -timeout 30s ./internal/usecase/... &&
            echo 'ğŸ—„ï¸ Infrastructureå±¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ' &&
            go test -v -timeout 30s ./internal/infrastructure/... &&
            echo 'ğŸŒ Interfaceå±¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ' &&
            go test -v -timeout 30s ./internal/interface/... &&
            echo 'âœ… å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Œäº†'
          "
      working-directory: ./backend
      env:
        GO_VERSION: "1.21"
        CI: "true"

  build-test:
    name: Build and Basic Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t slm-handson-backend:test .
      working-directory: ./backend
    
    - name: Start application in Docker
      run: |
        docker run -d --name test-app -p 8080:8080 \
          -e NEW_RELIC_API_KEY="" \
          -e NEW_RELIC_APP_NAME="test-app" \
          slm-handson-backend:test
        
        # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’å¾…ã¤
        echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
        for i in {1..30}; do
          if curl -f http://localhost:8080/health > /dev/null 2>&1; then
            echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·å‹•ã—ã¾ã—ãŸ"
            break
          fi
          echo "èµ·å‹•å¾…æ©Ÿä¸­... ($i/30)"
          sleep 2
        done
    
    - name: Run basic API tests
      run: |
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã¿ãƒ†ã‚¹ãƒˆï¼ˆç¢ºå®Ÿã«å‹•ä½œã™ã‚‹ã‚‚ã®ï¼‰
        curl -f http://localhost:8080/health
        echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
    
    - name: Stop and remove Docker container
      if: always()
      run: |
        docker stop test-app || true
        docker rm test-app || true